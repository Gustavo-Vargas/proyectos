{% extends 'base.html' %}
{% load static %}

{% block titulo %}
    Lista de artículos
{% endblock titulo %}

{% block page_title %}
    Artículos
{% endblock page_title %}

{% block breadcrumb %}
    <li class="breadcrumb-item active" aria-current="page">Tienda</li>
{% endblock breadcrumb %}

{% block contenido %}
<section class="container py-4">
    {% if articulos %}
    <div class="row g-4">
        {% for articulo in articulos %}
        <div class="col-12 col-sm-6 col-lg-4">
            <div class="card h-100 border-0 shadow-sm bg-body">
                <div class="p-3 pb-0">
                    {% with main=articulo.fotos.all|first %}
                    <div class="ratio ratio-4x3 rounded bg-body-secondary overflow-hidden">
                        {% if main %}
                        <img src="{{ main.imagen.url }}" alt="{{ articulo.nombre }}" class="w-100 h-100 object-fit-cover articulo-imagen" id="articulo-imagen-{{ articulo.id }}">
                        {% else %}
                        <img src="{% static './assets/img/default-150x150.png' %}" alt="{{ articulo.nombre }}" class="w-100 h-100 object-fit-cover articulo-imagen" id="articulo-imagen-{{ articulo.id }}">
                        {% endif %}
                    </div>
                    {% endwith %}
                    {% if articulo.fotos.all %}
                    <div class="d-flex justify-content-center gap-2 mt-3">
                        {% for foto in articulo.fotos.all %}
                        <button type="button" class="btn btn-outline-primary articulo-selector" data-target="articulo-imagen-{{ articulo.id }}" data-src="{{ foto.imagen.url }}" style="width: 14px; height: 14px; border-radius: 50%; padding: 0;"></button>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title text-center text-capitalize">{{ articulo.nombre }}</h5>
                    <p class="card-text text-muted flex-grow-1">{{ articulo.description|default:"Sin descripción" }}</p>
                    <div class="d-flex justify-content-between align-items-center mt-2">
                        <span class="badge text-bg-primary">{{ articulo.categoria.nombre }}</span>
                        {% if articulo.stock_disponible %}
                        <span class="text-success fw-semibold">Stock {{ articulo.stock_disponible }}</span>
                        {% else %}
                        <span class="text-danger fw-semibold">Sin stock</span>
                        {% endif %}
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-2">
                        <span class="text-secondary">Precio</span>
                        <span class="fs-5 fw-semibold">${{ articulo.precio|floatformat:2 }}</span>
                    </div>                   

                    <form action="{% url 'carrito_agregar' articulo.id %}" method="post" class="mt-3 d-flex flex-column gap-2 quantity-control">
                        {% csrf_token %}
                        <div class="d-flex align-items-center gap-2">
                            <div class="d-flex align-items-center gap-2">
                                <button type="button" class="btn btn-outline-secondary btn-sm quantity-btn" data-step="-1" aria-label="Disminuir cantidad para {{ articulo.nombre }}">
                                    <i class="bi bi-dash"></i>
                                </button>
                                <span class="badge text-bg-dark fs-6 px-3 quantity-display">1</span>
                                <button type="button" class="btn btn-outline-secondary btn-sm quantity-btn" data-step="1" aria-label="Incrementar cantidad para {{ articulo.nombre }}">
                                    <i class="bi bi-plus"></i>
                                </button>
                            </div>
                            <input type="hidden" name="cantidad" class="cantidad-input" value="1" data-stock="{{ articulo.stock_disponible }}" data-min="1">
                            <button type="submit" class="btn btn-dark flex-grow-1" {% if articulo.stock_disponible == 0 %}disabled{% endif %}>Agregar al carrito</button>
                        </div>
                    </form>

                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    <div class="d-flex justify-content-center mt-4">
        {% if is_paginated %}
        <nav>
            <ul class="pagination pagination-sm">
                {% if page_obj.has_previous %}
                <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">&laquo;</a></li>
                {% else %}
                <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
                {% endif %}
                {% for numero in paginator.page_range %}
                {% if numero == page_obj.number %}
                <li class="page-item active"><span class="page-link">{{ numero }}</span></li>
                {% else %}
                <li class="page-item"><a class="page-link" href="?page={{ numero }}">{{ numero }}</a></li>
                {% endif %}
                {% endfor %}
                {% if page_obj.has_next %}
                <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">&raquo;</a></li>
                {% else %}
                <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
    {% else %}
    <div class="alert alert-info text-center">No hay artículos disponibles.</div>
    {% endif %}
</section>

{% endblock contenido %}


{% block scripts %}
    {{ block.super }}
    <script src="{% static './js/tienda.js' %}"></script>
{% endblock scripts %}
